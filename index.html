<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ORIPA</title>
  <style>
    :root{
      --bg:#05060a;
      --white: #fff;
      --muted:#b6b9c6;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.14);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(1200px 700px at 50% 30%, #0c1030 0%, var(--bg) 45%, #000 100%);
      color: var(--white);
      overflow-x:hidden;
    }
    .wrap{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:18px;
      padding:32px 16px;
      text-align:center;
    }
    h1{
      margin:0;
      font-size:28px;
      letter-spacing:.08em;
      font-weight:900;
    }
    .sub{color:var(--muted); font-size:13px}
    .card{
      width:min(540px, 96vw);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(900px 250px at 20% 0%, rgba(0,255,255,.12), transparent 60%),
                  radial-gradient(900px 250px at 80% 0%, rgba(255,0,255,.12), transparent 60%);
      pointer-events:none;
      filter: blur(0px);
      opacity:.9;
    }
    .row{
      position:relative;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      z-index:1;
    }
    button{
      border:none;
      border-radius: 16px;
      padding: 14px 18px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      letter-spacing:.04em;
    }
    button:active{transform: scale(.98)}
    .btn{
      background: linear-gradient(135deg, #00e5ff, #7c4dff);
      color:#05060a;
      box-shadow: 0 14px 35px rgba(124,77,255,.35);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; filter:grayscale(.25)}
    .btn2{
      background: transparent;
      color: var(--white);
      border: 1px solid rgba(255,255,255,.22);
    }

    /* ====== MODAL / STAGE ====== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.85);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .modal.show{display:flex}
    .stage{
      width:min(720px, 96vw);
      height:min(780px, 92vh);
      border-radius: 28px;
      background: radial-gradient(900px 600px at 50% 35%, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      overflow:hidden;
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
    }
    .vignette{
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 50% 35%, rgba(0,0,0,.0) 0%, rgba(0,0,0,.65) 60%, rgba(0,0,0,.92) 100%);
      pointer-events:none;
      z-index:2;
    }
    .spot{
      position:absolute;
      width: 540px; height: 540px;
      left:50%; top: 26%;
      transform: translate(-50%, -50%);
      background: radial-gradient(circle, rgba(255,255,255,.35) 0%, rgba(255,255,255,.10) 25%, transparent 70%);
      filter: blur(1px);
      opacity:.0;
      z-index:1;
      transition: opacity .35s ease;
    }
    .spot.on{opacity:1}

    /* particles canvas */
    canvas#fx{
      position:absolute; inset:0;
      z-index:3;
    }

    /* floor */
    .floor{
      position:absolute; left:50%; bottom:18%;
      transform: translateX(-50%);
      width: 520px; height: 80px;
      background: radial-gradient(closest-side, rgba(255,255,255,.12), rgba(255,255,255,0));
      filter: blur(0px);
      opacity:.9;
      z-index:1;
    }

    /* chest */
    .chestWrap{
      position:absolute;
      left:50%; top:44%;
      transform: translate(-50%, -50%);
      z-index:4;
      text-align:center;
    }
    .chest{
      width: 240px; height: 240px;
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)),
        radial-gradient(120px 120px at 40% 35%, rgba(255,255,255,.10), transparent 65%),
        radial-gradient(120px 120px at 60% 55%, rgba(255,255,255,.08), transparent 65%);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 24px 70px rgba(0,0,0,.65);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      transform: translateY(-460px) scale(.92);
      opacity:0;
    }
    .chest:before{
      content:"";
      position:absolute; inset:-30%;
      background: conic-gradient(from 0deg, rgba(0,229,255,.18), rgba(124,77,255,.18), rgba(255,64,129,.14), rgba(0,229,255,.18));
      filter: blur(12px);
      opacity:.0;
      transition: opacity .25s ease;
    }
    .chest.ready:before{opacity:1}
    .chestLabel{
      font-weight:950;
      letter-spacing:.08em;
      font-size:18px;
      color:#fff;
      text-shadow: 0 8px 20px rgba(0,0,0,.55);
      z-index:1;
    }

    /* entrance drop */
    .dropIn{
      animation: dropIn .55s cubic-bezier(.2,1.2,.2,1) forwards;
    }
    @keyframes dropIn{
      0%{ transform: translateY(-460px) scale(.92); opacity:0; }
      60%{ transform: translateY(10px) scale(1.02); opacity:1; }
      100%{ transform: translateY(0px) scale(1.0); opacity:1; }
    }

    /* don-don */
    .don{
      animation: donShake .12s infinite alternate, donPulse .26s infinite alternate;
    }
    @keyframes donShake{
      from{ transform: translateY(0) translateX(-6px) rotate(-1deg); }
      to  { transform: translateY(0) translateX(6px) rotate(1deg); }
    }
    @keyframes donPulse{
      from{ filter: brightness(1.0); }
      to  { filter: brightness(1.25); }
    }

    /* open flash */
    .flash{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 38%, rgba(255,255,255,.95) 0%, rgba(255,255,255,.20) 25%, transparent 60%);
      opacity:0;
      z-index:10;
      pointer-events:none;
    }
    .flash.go{animation: flash .45s ease-out forwards;}
    @keyframes flash{
      0%{opacity:0}
      25%{opacity:1}
      100%{opacity:0}
    }

    /* glow ring (rank) */
    .glow{
      position:absolute;
      left:50%; top:44%;
      transform: translate(-50%, -50%);
      width: 380px; height: 380px;
      border-radius:50%;
      opacity:0;
      z-index:1;
      filter: blur(0px);
    }
    .glow.show{animation: glowIn .55s ease forwards;}
    @keyframes glowIn{
      0%{opacity:0; transform: translate(-50%,-50%) scale(.75)}
      100%{opacity:.85; transform: translate(-50%,-50%) scale(1)}
    }
    .glow.lose{background:#ff3b30}
    .glow.a{background:#34c759}
    .glow.s{background:#ffd700}
    .glow.ss{
      background: conic-gradient(red, orange, yellow, green, cyan, blue, purple, red);
      animation: glowIn .55s ease forwards, spin 1.6s linear infinite;
    }
    @keyframes spin{to{transform: translate(-50%,-50%) scale(1) rotate(360deg)}}

    /* result box */
    .result{
      position:absolute;
      left:50%; bottom:10%;
      transform: translateX(-50%);
      width:min(520px, 92%);
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 18px;
      padding: 14px 14px 16px;
      z-index:11;
      opacity:0;
    }
    .result.show{animation: rise .55s cubic-bezier(.2,1.2,.2,1) forwards;}
    @keyframes rise{
      0%{opacity:0; transform: translateX(-50%) translateY(20px)}
      100%{opacity:1; transform: translateX(-50%) translateY(0px)}
    }
    .rankText{font-size:28px; font-weight:950; letter-spacing:.06em}
    .cardName{color:#d9dbe6; margin-top:6px; font-weight:700}
    .small{color:var(--muted); font-size:12px; margin-top:6px}

    .stageBtns{
      position:absolute;
      left:50%; top:6%;
      transform: translateX(-50%);
      display:flex; gap:10px;
      z-index:20;
    }
    .pill{
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      font-size:13px;
      color:#fff;
    }
  </style>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>ORIPA</h1>
    <div class="card">
      <div class="row">
        <button class="btn" id="drawBtn">オリパを引く！</button>
        <button class="btn2" id="openStageBtn">演出だけテスト</button>
      </div>
      <div class="sub" style="margin-top:10px;">
        黒→宝箱→ドンドン→開封→色＆粒子（赤/緑/金/虹）
      </div>
    </div>
    <div class="sub">GitHub Pages + Firebase Functions（開発用デモ）</div>
  </div>

  <div class="modal" id="modal">
    <div class="stage" id="stage">
      <div class="spot" id="spot"></div>
      <div class="floor"></div>
      <div class="glow" id="glow"></div>
      <div class="chestWrap">
        <div class="chest" id="chest"><div class="chestLabel" id="chestLabel">TREASURE</div></div>
      </div>
      <div class="flash" id="flash"></div>
      <canvas id="fx"></canvas>
      <div class="vignette"></div>

      <div class="stageBtns">
        <span class="pill" id="closeBtn">閉じる</span>
        <span class="pill" id="againBtn" style="opacity:.6; pointer-events:none;">もう1回</span>
      </div>

      <div class="result" id="result">
        <div class="rankText" id="rankText"></div>
        <div class="cardName" id="cardName"></div>
        <div class="small" id="debugText"></div>
      </div>
    </div>
  </div>

<script>
  // ✅ ここだけ自分のに差し替え
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const functions = firebase.functions();

  const drawBtn = document.getElementById('drawBtn');
  const openStageBtn = document.getElementById('openStageBtn');

  const modal = document.getElementById('modal');
  const stage = document.getElementById('stage');
  const spot = document.getElementById('spot');
  const chest = document.getElementById('chest');
  const chestLabel = document.getElementById('chestLabel');
  const glow = document.getElementById('glow');
  const flash = document.getElementById('flash');
  const result = document.getElementById('result');
  const rankText = document.getElementById('rankText');
  const cardName = document.getElementById('cardName');
  const debugText = document.getElementById('debugText');
  const closeBtn = document.getElementById('closeBtn');
  const againBtn = document.getElementById('againBtn');

  const canvas = document.getElementById('fx');
  const ctx = canvas.getContext('2d');
  let W=0,H=0, particles=[], raf=0;
  function resize(){
    const r = stage.getBoundingClientRect();
    W = canvas.width = Math.floor(r.width * devicePixelRatio);
    H = canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener('resize', ()=>{ if(modal.classList.contains('show')) resize(); });

  function rand(a,b){ return a + Math.random()*(b-a); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function makeParticles(rank){
    particles.length = 0;
    const base = rank==='SS' ? 260 : rank==='S' ? 170 : rank==='A' ? 130 : 90;
    const colors =
      rank==='SS' ? ['#ff3b30','#ffcc00','#34c759','#00e5ff','#7c4dff','#ff40a1'] :
      rank==='S'  ? ['#ffd700','#fff2a6','#ffcc00','#ffe27a'] :
      rank==='A'  ? ['#34c759','#b7ffd1','#66ff9e'] :
                   ['#ff3b30','#ff7a70','#ffb0aa'];

    const r = stage.getBoundingClientRect();
    const cx = (r.width/2) * devicePixelRatio;
    const cy = (r.height*0.44) * devicePixelRatio;

    for(let i=0;i<base;i++){
      const ang = rand(-Math.PI*0.95, -Math.PI*0.05);
      const sp = rand(6, 18) * devicePixelRatio;
      particles.push({
        x: cx + rand(-20,20)*devicePixelRatio,
        y: cy + rand(-10,10)*devicePixelRatio,
        vx: Math.cos(ang)*sp,
        vy: Math.sin(ang)*sp,
        g: rand(0.35, 0.85) * devicePixelRatio,
        s: rand(1.2, 3.6) * devicePixelRatio,
        a: rand(0.6, 1.0),
        c: pick(colors),
        life: rand(26, 68)
      });
    }
  }

  function tick(){
    ctx.clearRect(0,0,W,H);
    for(const p of particles){
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.vx *= 0.98;
      p.vy *= 0.985;
      p.life -= 1;
      p.a *= 0.985;

      ctx.globalAlpha = Math.max(0, p.a);
      ctx.fillStyle = p.c;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.s, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
    particles = particles.filter(p => p.life > 0 && p.a > 0.02);
    raf = requestAnimationFrame(tick);
  }

  async function ensureAnonLogin(){
    if(auth.currentUser) return auth.currentUser;
    const cred = await auth.signInAnonymously();
    return cred.user;
  }

  function resetStage(){
    spot.classList.remove('on');
    chest.className = 'chest';
    glow.className = 'glow';
    result.classList.remove('show');
    flash.classList.remove('go');
    chestLabel.textContent = 'TREASURE';
    rankText.textContent = '';
    cardName.textContent = '';
    debugText.textContent = '';
    againBtn.style.opacity = .6;
    againBtn.style.pointerEvents = 'none';
    cancelAnimationFrame(raf);
    particles.length = 0;
    ctx.clearRect(0,0,W,H);
  }

  function setGlow(rank){
    glow.className = 'glow show';
    glow.classList.remove('lose','a','s','ss');
    if(rank === 'SS') glow.classList.add('ss');
    else if(rank === 'S') glow.classList.add('s');
    else if(rank === 'A') glow.classList.add('a');
    else glow.classList.add('lose');
  }

  function rankLabel(rank){
    if(rank==='SS') return 'SS賞 獲得！';
    if(rank==='S')  return 'S賞 獲得！';
    if(rank==='A')  return 'A賞 獲得！';
    return 'ハズレ';
  }

  function microShake(ms=260){
    const t0 = performance.now();
    const amp = 3;
    function step(t){
      const k = Math.min(1, (t - t0)/ms);
      const x = (Math.random()*2-1) * amp * (1-k);
      const y = (Math.random()*2-1) * amp * (1-k);
      stage.style.transform = `translate(${x}px, ${y}px)`;
      if(k < 1) requestAnimationFrame(step);
      else stage.style.transform = '';
    }
    requestAnimationFrame(step);
  }

  async function playSequence(getRankFn){
    resetStage();
    modal.classList.add('show');
    resize();

    spot.classList.add('on');

    // 宝箱着地
    chest.classList.add('dropIn');
    await new Promise(r => setTimeout(r, 520));
    chest.classList.add('ready');

    // ドンドン
    chest.classList.add('don');
    microShake(220);
    await new Promise(r => setTimeout(r, 1100));

    // 取得（Firebase or テスト）
    const { rank, name, debug } = await getRankFn();

    // 開封フラッシュ
    chest.classList.remove('don');
    flash.classList.add('go');
    microShake(320);

    // 色＆粒子
    setGlow(rank);
    makeParticles(rank);
    tick();

    chestLabel.textContent = 'OPEN!';
    rankText.textContent = rankLabel(rank);
    cardName.textContent = name || '';
    debugText.textContent = debug || '';

    result.classList.add('show');
    againBtn.style.opacity = 1;
    againBtn.style.pointerEvents = 'auto';
  }

  // 本番：Firebase callable openOripa
  async function drawFromFirebase(){
    await ensureAnonLogin();
    const openOripa = functions.httpsCallable('openOripa');
    const res = await openOripa({ oripaId: "oripa_001" });
    const data = res.data || {};
    const rank = (data.rank || 'LOSE').toUpperCase();
    return { rank, name: data.cardName || '', debug: '' };
  }

  // 演出テスト：ローカルでランダム
  async function drawLocal(){
    await new Promise(r=>setTimeout(r, 350));
    const r = Math.random();
    const rank = r < 0.01 ? 'SS' : r < 0.05 ? 'S' : r < 0.20 ? 'A' : 'LOSE';
    return { rank, name: 'デモカード', debug: '(ローカル抽選)' };
  }

  drawBtn.addEventListener('click', async ()=>{
    drawBtn.disabled = true;
    try { await playSequence(drawFromFirebase); }
    catch(e){ alert('Firebase設定かFunctionsが未設定: ' + (e?.message || e)); }
    finally { drawBtn.disabled = false; }
  });

  openStageBtn.addEventListener('click', ()=> playSequence(drawLocal));

  closeBtn.addEventListener('click', ()=>{
    modal.classList.remove('show');
    resetStage();
  });

  againBtn.addEventListener('click', ()=> playSequence(drawFromFirebase));
</script>
</body>
</html>

