<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>オリパ</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#111; color:#fff; }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; }
    button { padding:14px 18px; font-size:18px; border-radius:12px; border:none; cursor:pointer; font-weight:800; }
    .btn { background:#00b894; color:#000; }
    .modal {
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.92);
      align-items:center; justify-content:center; flex-direction:column; gap:14px;
    }
    .modal.show { display:flex; }
    .chest {
      width:220px; height:220px; background:#333; border-radius:18px;
      display:flex; align-items:center; justify-content:center;
      transform-origin:center;
    }
    .shake { animation: shake .12s infinite alternate, pulse .25s infinite alternate; }
    @keyframes shake { from { transform: translateX(-6px) scale(1); } to { transform: translateX(6px) scale(1); } }
    @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.12); } }

    .glow {
      position:absolute; width:340px; height:340px; border-radius:50%;
      opacity:.7; filter: blur(0px);
      display:none;
    }
    .glow.show { display:block; }

    .lose { background:#ff3b30; }
    .a { background:#34c759; }
    .s { background:#ffd700; }
    .ss {
      background: conic-gradient(red, orange, yellow, green, cyan, blue, purple, red);
    }

    .result { text-align:center; display:none; }
    .result.show { display:block; }
    .rank { font-size:28px; font-weight:900; }
    .name { color:#ddd; margin-top:6px; }
  </style>

  <!-- Firebase (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h2>オリパ</h2>
    <button class="btn" id="drawBtn">オリパを引く！</button>
    <div style="color:#aaa;font-size:13px;">※開発用デモ</div>
  </div>

  <div class="modal" id="modal">
    <div class="glow" id="glow"></div>
    <div class="chest" id="chest">宝箱</div>
    <div class="result" id="result">
      <div class="rank" id="rankText"></div>
      <div class="name" id="cardName"></div>
    </div>
    <button id="againBtn" style="display:none;">もう1回</button>
  </div>

<script>
  // TODO: ここをあなたのFirebase設定に差し替える
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const functions = firebase.functions(); // 同一リージョンならOK（必要なら functions.useEmulator / region対応）

  const drawBtn = document.getElementById('drawBtn');
  const modal = document.getElementById('modal');
  const chest = document.getElementById('chest');
  const glow = document.getElementById('glow');
  const result = document.getElementById('result');
  const rankText = document.getElementById('rankText');
  const cardName = document.getElementById('cardName');
  const againBtn = document.getElementById('againBtn');

  function setGlow(rank){
    glow.className = 'glow show';
    glow.classList.remove('lose','a','s','ss');
    if(rank === 'SS') glow.classList.add('ss');
    else if(rank === 'S') glow.classList.add('s');
    else if(rank === 'A') glow.classList.add('a');
    else glow.classList.add('lose');
  }

  async function ensureAnonLogin(){
    if(auth.currentUser) return auth.currentUser;
    const cred = await auth.signInAnonymously();
    return cred.user;
  }

  async function openSequence(){
    drawBtn.disabled = true;
    result.classList.remove('show');
    againBtn.style.display = 'none';
    glow.classList.remove('show');

    modal.classList.add('show');
    chest.classList.add('shake');
    chest.textContent = '宝箱';

    await new Promise(r => setTimeout(r, 1200));

    await ensureAnonLogin();

    // openOripa (callable) を呼ぶ
    const openOripa = functions.httpsCallable('openOripa');
    const res = await openOripa({ oripaId: "oripa_001" });
    const data = res.data || {};
    const rank = (data.rank || "LOSE").toUpperCase();

    chest.classList.remove('shake');
    chest.textContent = 'OPEN!';

    setGlow(rank);

    rankText.textContent =
      rank === 'SS' ? 'SS賞 獲得！' :
      rank === 'S'  ? 'S賞 獲得！' :
      rank === 'A'  ? 'A賞 獲得！' : 'ハズレ';

    cardName.textContent = data.cardName || '';

    result.classList.add('show');
    againBtn.style.display = 'inline-block';
    drawBtn.disabled = false;
  }

  drawBtn.addEventListener('click', openSequence);
  againBtn.addEventListener('click', openSequence);
</script>
</body>
</html>




