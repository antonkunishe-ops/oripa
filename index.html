<!doctype html>
<html lang="ja">
</html>
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>オリパ抽選</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7f7; margin:0; }
    .box { max-width:420px; margin:40px auto; background:#fff; padding:20px; border-radius:16px; }
    h2 { text-align:center; margin:6px 0 14px; }
    button{
      width:100%; padding:16px; font-size:18px; border-radius:14px; border:none;
      background:#ffcb05; cursor:pointer;
    }
    button:disabled{ opacity:.7; cursor:not-allowed; }

    .result{
      margin-top:16px; padding:18px 16px; background:#eee; border-radius:14px;
      text-align:center; font-size:18px; min-height:56px;
      display:flex; align-items:center; justify-content:center;
      border:2px solid transparent;
    }
    .ss{ background:#fff3c4 !important; border-color:#e6b800; }
    .s { background:#e8f4ff !important; border-color:#4aa3ff; }
    .a { background:#eaffea !important; border-color:#3bd13b; }
    .lose{ background:#eee !important; }

    .note{ margin-top:10px; font-size:12px; color:#666; text-align:center; }

    /* ===== 演出用オーバーレイ ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.72);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
      padding:20px;
    }
    .overlay.show{ display:flex; }
    .stage{
      width:min(520px, 96vw);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.15);
      border-radius:18px;
      padding:22px 18px 18px;
      text-align:center;
      color:#fff;
      backdrop-filter: blur(6px);
    }
    .stage h3{ margin:0 0 10px; font-size:18px; font-weight:600; opacity:.95; }
    .sub{ font-size:14px; opacity:.85; margin-bottom:14px; }

    /* 宝箱（CSSで表現） */
    .chest-wrap{ display:flex; justify-content:center; margin:8px 0 8px; }
    .chest{
      position:relative;
      width:220px; height:150px;
      transform: translateZ(0);
    }
    .lid{
      position:absolute; left:10px; right:10px; top:16px;
      height:56px;
      background:linear-gradient(180deg,#ffcb05,#d89b00);
      border-radius:14px 14px 10px 10px;
      box-shadow:0 10px 0 rgba(0,0,0,.18);
      transform-origin: 50% 100%;
      transform: rotateX(0deg);
      transition: transform 700ms cubic-bezier(.2,.8,.2,1);
      border:2px solid rgba(0,0,0,.25);
    }
    .base{
      position:absolute; left:10px; right:10px; bottom:14px;
      height:78px;
      background:linear-gradient(180deg,#8b5a2b,#5a3a1c);
      border-radius:14px;
      border:2px solid rgba(0,0,0,.25);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .band{
      position:absolute; left:0; right:0; top:32px;
      height:14px;
      background:rgba(0,0,0,.18);
    }
    .lock{
      position:absolute; left:50%; top:54px;
      width:42px; height:34px;
      transform:translateX(-50%);
      background:linear-gradient(180deg,#f7f7f7,#bdbdbd);
      border-radius:10px;
      border:2px solid rgba(0,0,0,.25);
    }
    .lock:after{
      content:"";
      position:absolute; left:50%; top:-18px;
      width:24px; height:22px;
      transform:translateX(-50%);
      border:5px solid rgba(255,255,255,.85);
      border-bottom:none;
      border-radius:14px 14px 0 0;
      opacity:.7;
    }

    /* ドンドン中の揺れ */
    .shake{
      animation: chestShake 120ms infinite;
    }
    @keyframes chestShake{
      0%{ transform:translateX(0) rotate(0deg); }
      25%{ transform:translateX(-2px) rotate(-0.4deg); }
      50%{ transform:translateX(2px) rotate(0.4deg); }
      75%{ transform:translateX(-1px) rotate(-0.2deg); }
      100%{ transform:translateX(0) rotate(0deg); }
    }

    /* フラッシュ（開く瞬間） */
    .flash{
      position:fixed; inset:0;
      background:rgba(255,255,255,.0);
      pointer-events:none;
      opacity:0;
      z-index:10000;
    }
    .flash.on{
      animation: flash 380ms ease-out;
    }
    @keyframes flash{
      0%{ opacity:0; }
      20%{ opacity:.95; }
      100%{ opacity:0; }
    }

    /* ふたが開く */
    .open .lid{
      transform: rotateX(70deg) translateY(-6px);
    }

    /* 結果カード */
    .reveal{
      margin-top:14px;
      display:none;
      background:rgba(255,255,255,.92);
      color:#111;
      border-radius:14px;
      padding:14px 12px;
      font-size:18px;
      border:2px solid rgba(255,255,255,.55);
    }
    .reveal.show{ display:block; }
    .badge{
      display:inline-block;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      margin-bottom:8px;
      background:#111;
      color:#fff;
    }
    .reveal.ss{ border-color:#e6b800; }
    .reveal.s{ border-color:#4aa3ff; }
    .reveal.a{ border-color:#3bd13b; }
    .reveal.lose{ border-color:#bbb; }

    .closebtn{
      margin-top:12px;
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      background:rgba(255,255,255,.18);
      color:#fff;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>ポケモン オリパ</h2>
    <button id="draw">オリパを引く！</button>
    <div id="result" class="result lose">結果がここに表示されます</div>
    <div class="note">※ デモ用（結果表示のみ）</div>
  </div>

  <!-- 演出オーバーレイ -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="stage">
      <h3>宝箱を開けます…</h3>
      <div id="sub" class="sub">ドキドキ…</div>

      <div class="chest-wrap">
        <div id="chest" class="chest">
          <div class="lid"></div>
          <div class="base">
            <div class="band"></div>
          </div>
          <div class="lock"></div>
        </div>
      </div>

      <div id="reveal" class="reveal">
        <div id="badge" class="badge">結果</div>
        <div id="revealText" style="font-weight:700;"></div>
      </div>

      <button id="close" class="closebtn" style="display:none;">閉じる</button>
    </div>
  </div>
  <div id="flash" class="flash"></div>

  <script>
    // ===== 確率（％管理・合計100）=====
    const prizes = [
      { key: "ss",  name: "SS賞：激レア", w: 1 },   // 1%
      { key: "s",   name: "S賞：レア",   w: 4 },   // 4%
      { key: "a",   name: "A賞：当たり", w: 15 },  // 15%
      { key: "lose",name: "ハズレ",      w: 80 }   // 80%
    ];

    function drawPrize(){
      const total = prizes.reduce((sum,p)=>sum+p.w,0);
      let r = Math.random()*total;
      for(const p of prizes){
        r -= p.w;
        if(r < 0) return p;
      }
      return prizes[prizes.length-1];
    }

    // ===== 音（WebAudio / 外部ファイルなし）=====
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();

    function tone(freq, ms, type="sine", gain=0.07){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + ms/1000);
    }

    // ドンドン（低めの打撃音っぽく）
    function don(){
      tone(120, 70, "square", 0.06);
      setTimeout(()=>tone(90, 90, "sine", 0.05), 10);
    }

    // 開く瞬間
    function openSound(){
      tone(440, 90, "triangle", 0.05);
      setTimeout(()=>tone(880, 120, "triangle", 0.06), 90);
    }

    // 当選音
    function resultSound(key){
      if(key === "ss"){
        tone(880, 120, "sine", 0.08);
        setTimeout(()=>tone(1320, 140, "sine", 0.08), 120);
        setTimeout(()=>tone(1760, 180, "sine", 0.08), 260);
      }else if(key === "s"){
        tone(660, 140, "triangle", 0.07);
        setTimeout(()=>tone(990, 170, "triangle", 0.07), 140);
      }else if(key === "a"){
        tone(523, 140, "sine", 0.06);
        setTimeout(()=>tone(784, 160, "sine", 0.06), 140);
      }else{
        tone(220, 220, "sawtooth", 0.04);
      }
    }

    // ===== UI参照 =====
    const btn = document.getElementById("draw");
    const result = document.getElementById("result");

    const overlay = document.getElementById("overlay");
    const chest = document.getElementById("chest");
    const sub = document.getElementById("sub");
    const reveal = document.getElementById("reveal");
    const revealText = document.getElementById("revealText");
    const badge = document.getElementById("badge");
    const closeBtn = document.getElementById("close");
    const flash = document.getElementById("flash");

    function setMainResultClass(key){
      result.classList.remove("ss","s","a","lose");
      result.classList.add(key);
    }
    function setRevealClass(key){
      reveal.classList.remove("ss","s","a","lose");
      reveal.classList.add(key);
    }

    function showOverlay(){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
    }
    function hideOverlay(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }

    function resetOverlay(){
      chest.classList.remove("shake","open");
      reveal.classList.remove("show");
      closeBtn.style.display = "none";
      sub.textContent = "ドキドキ…";
      badge.textContent = "結果";
      revealText.textContent = "";
    }

    btn.onclick = async () => {
      if (ctx.state !== "running") await ctx.resume();

      btn.disabled = true;
      resetOverlay();
      showOverlay();

      // 1) 暗転＆宝箱登場 → ドンドン（3回）
      chest.classList.add("shake");
      sub.textContent = "どん…どん…どん…";
      let count = 0;
      const interval = setInterval(()=>{
        don();
        count++;
        if(count >= 3){
          clearInterval(interval);

          // 2) 開く
          chest.classList.remove("shake");
          sub.textContent = "いくよ…オープン！";
          openSound();
          flash.classList.add("on");
          setTimeout(()=>flash.classList.remove("on"), 450);

          chest.classList.add("open");

          // 3) 結果を表示
          setTimeout(()=>{
            const p = drawPrize();

            // オーバーレイ内
            setRevealClass(p.key);
            revealText.textContent = p.name;
            badge.textContent = "結果";
            reveal.classList.add("show");
            resultSound(p.key);

            // メイン画面にも反映
            setMainResultClass(p.key);
            result.textContent = p.name;

            sub.textContent = "結果はこちら！";
            closeBtn.style.display = "block";
            btn.disabled = false;
          }, 900);
        }
      }, 420);
    };

    closeBtn.onclick = () => {
      hideOverlay();
    };

    // オーバーレイ外クリックで閉じない（誤タップ防止）
  </script>
</body>
</html>
